name: Build Android APK

on:
  workflow_dispatch:  # 只允许手动触发，避免频繁构建

jobs:
  build-with-docker:
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # 延长构建时间
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Clean previous builds
      run: |
        rm -rf bin/ .buildozer/ output/ *.log 2>/dev/null || true
        mkdir -p bin .buildozer output
    
    - name: Build APK using Docker
      run: |
        echo "========================================"
        echo "开始使用Docker构建APK..."
        echo "========================================"
        
        # 使用官方Buildozer镜像构建
        docker run --rm \
          -v $(pwd):/app \
          --privileged \
          kivymd/buildozer:stable \
          bash -c "cd /app && buildozer -v android debug"
        
        echo "========================================"
        echo "Docker构建完成！"
        echo "========================================"
    
    - name: List build output
      run: |
        echo "=== 构建输出目录内容 ==="
        ls -la ./
        echo "\n=== bin目录内容 ==="
        ls -la ./bin 2>/dev/null || echo "bin目录不存在"
        echo "\n=== 查找APK文件 ==="
        find . -name "*.apk" 2>/dev/null || echo "未找到APK文件"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: shanhaijing-apk-build
        path: |
          bin/*.apk
          .buildozer/android/logs/*.log
          *.log
        retention-days: 30
        if-no-files-found: error
