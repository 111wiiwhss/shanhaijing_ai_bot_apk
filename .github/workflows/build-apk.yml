name: Build APK for 山海经异变AI代练

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install Buildozer
        run: |
          python -m pip install --upgrade pip
          pip install buildozer
      
      - name: Install Buildozer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \n            build-essential \n            ccache \n            git \n            zlib1g-dev \n            libncurses5-dev \n            libgdbm-dev \n            libnss3-dev \n            libssl-dev \n            libreadline-dev \n            libffi-dev \n            libsqlite3-dev \n            libbz2-dev \n            liblzma-dev \n            zlib1g-dev \n            python3-dev \n            python3-pip \n            python3-venv \n            python3-setuptools \n            python3-wheel \n            python3-cryptography \n            libgl1-mesa-dev \n            libx11-dev \n            libxext-dev \n            libxrender-dev \n            libxrandr-dev \n            libxss-dev \n            libxtst-dev \n            libxv-dev \n            libxi-dev \n            libxkbcommon-dev \n            libxkbcommon-x11-dev \n            libwayland-dev \n            libxkbfile-dev \n            libfontconfig1-dev \n            libfreetype6-dev \n            libharfbuzz-dev \n            libfribidi-dev \n            libpng-dev \n            libjpeg-dev \n            libtiff-dev \n            libopenjp2-7-dev \n            libwebp-dev \n            liblcms2-dev \n            liblcms2-utils \n            libraqm-dev \n            libxcb1-dev \n            libxcb-icccm4-dev \n            libxcb-image0-dev \n            libxcb-keysyms1-dev \n            libxcb-randr0-dev \n            libxcb-render-util0-dev \n            libxcb-shape0-dev \n            libxcb-shm0-dev \n            libxcb-xfixes0-dev \n            libxcb-xinerama0-dev \n            libxcb-xkb-dev
      
      - name: Build APK
        run: |
          buildozer android debug
        env:
          P4A_ANDROID_API: 33
          P4A_MIN_SDK_VERSION: 21
          P4A_TARGET_SDK_VERSION: 33
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: shanhaijing-ai-bot-apk
          path: bin/shanhaijing_ai_bot-*-debug.apk
          retention-days: 30
